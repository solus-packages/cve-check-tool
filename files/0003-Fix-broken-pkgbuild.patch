From c771f78511613a424e4c0af874688358e16a95f7 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <michael.i.doherty@intel.com>
Date: Mon, 29 Jun 2015 10:31:43 +0100
Subject: [PATCH 03/13] Fix broken pkgbuild

Signed-off-by: Ikey Doherty <michael.i.doherty@intel.com>
---
 src/packaging/pkgbuild.c  | 4 ++--
 tests/check-core.c        | 1 +
 tests/check-database.c    | 1 +
 tests/check-jira-plugin.c | 1 +
 tests/check-packaging.c   | 3 ++-
 5 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/src/packaging/pkgbuild.c b/src/packaging/pkgbuild.c
index 692c538..779a944 100644
--- a/src/packaging/pkgbuild.c
+++ b/src/packaging/pkgbuild.c
@@ -96,8 +96,8 @@ bool pkgbuild_is_patched(struct source_package_t *pkg, char *id)
 {
         /* Determine if its patched. */
         autofree(gchar) *pnamet = g_ascii_strdown((gchar*)id, -1);
-        autofree(gchar) *pnamel = g_strdup_printf("%s/%s.nopatch", pkg->path, pnamet);
-        autofree(gchar) *pname = g_strdup_printf("%s/%s.nopatch", pkg->path, id);
+        autofree(gchar) *pnamel = g_strdup_printf("%s/%s.patch", pkg->path, pnamet);
+        autofree(gchar) *pname = g_strdup_printf("%s/%s.patch", pkg->path, id);
 
         if (g_file_test(pname, G_FILE_TEST_EXISTS) || g_file_test(pnamel, G_FILE_TEST_EXISTS)) {
                 return true;
diff --git a/tests/check-core.c b/tests/check-core.c
index 8a7432a..f4bbc26 100644
--- a/tests/check-core.c
+++ b/tests/check-core.c
@@ -19,6 +19,7 @@
 #include "rpm.c"
 #include "eopkg.c"
 #include "pkgbuild.c"
+#include "faux.c"
 
 #include "config.h"
 
diff --git a/tests/check-database.c b/tests/check-database.c
index 68ab1c3..1220075 100644
--- a/tests/check-database.c
+++ b/tests/check-database.c
@@ -21,6 +21,7 @@
 #include "rpm.c"
 #include "eopkg.c"
 #include "pkgbuild.c"
+#include "faux.c"
 
 #include "config.h"
 
diff --git a/tests/check-jira-plugin.c b/tests/check-jira-plugin.c
index 3fe0238..9a55f93 100644
--- a/tests/check-jira-plugin.c
+++ b/tests/check-jira-plugin.c
@@ -19,6 +19,7 @@
 #include "rpm.c"
 #include "eopkg.c"
 #include "pkgbuild.c"
+#include "faux.c"
 
 #include "config.h"
 #include "plugins/jira/jira.h"
diff --git a/tests/check-packaging.c b/tests/check-packaging.c
index 680fd5b..13f85c6 100644
--- a/tests/check-packaging.c
+++ b/tests/check-packaging.c
@@ -19,6 +19,7 @@
 #include "rpm.c"
 #include "eopkg.c"
 #include "pkgbuild.c"
+#include "faux.c"
 
 #include "config.h"
 
@@ -144,7 +145,7 @@ START_TEST(cve_pkgbuild_test)
         fail_if(pkg->release != 10, "Invalid PKGBUILD package release");
 
         fail_if(!pkgbuild_is_patched(pkg, "CVE-2014-5461"),
-                "Failed to detect eopkg CVE patch");
+                "Failed to detect pkgbuild CVE patch");
 
         package_free(pkg);
 }
-- 
2.4.6

