From 58728e99d5d2ad1d306ed0651648e39f6c9065a6 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <michael.i.doherty@intel.com>
Date: Thu, 16 Jul 2015 16:38:13 +0100
Subject: [PATCH 7/9] rpm: Ensure nopatch is also case sensitive

Signed-off-by: Ikey Doherty <michael.i.doherty@intel.com>
---
 Makefile.am                              |  2 +-
 src/packaging/rpm.c                      | 17 +++++++++--------
 tests/dummy_data/rpm/CVE-2014-5461.patch | 13 +++++++++++++
 tests/dummy_data/rpm/cve-2014-5461.patch | 13 -------------
 4 files changed, 23 insertions(+), 22 deletions(-)
 create mode 100644 tests/dummy_data/rpm/CVE-2014-5461.patch
 delete mode 100644 tests/dummy_data/rpm/cve-2014-5461.patch

diff --git a/Makefile.am b/Makefile.am
index 264b9b4..cecdab8 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -14,7 +14,7 @@ EXTRA_DIST = ${top_srcdir}/README.md \
 	     ${top_srcdir}/tests/dummy_data/rpm/cve-2014-5461.patch \
 	     ${top_srcdir}/tests/dummy_data/rpm/cve-2013-4459.nopatch \
 	     ${top_srcdir}/tests/dummy_data/eopkg/pspec.xml \
-	     ${top_srcdir}/tests/dummy_data/eopkg/files/security/cve-2014-5461.patch \
+	     ${top_srcdir}/tests/dummy_data/eopkg/files/security/CVE-2014-5461.patch \
 	     ${top_srcdir}/tests/dummy_data/eopkg/files/security/cve-2013-4459.nopatch \
 	     ${top_srcdir}/tests/dummy_data/pkgbuild/PKGBUILD \
 	     ${top_srcdir}/tests/dummy_data/pkgbuild/cve-2014-5461.patch \
diff --git a/src/packaging/rpm.c b/src/packaging/rpm.c
index bb052e5..d09182d 100644
--- a/src/packaging/rpm.c
+++ b/src/packaging/rpm.c
@@ -27,11 +27,11 @@ bool srpm_patch_check(struct source_package_t *t, char *id, bool ignore)
         gchar **list = t->extra;
 
         for (uint i = 0; i < g_strv_length(list); i++) {
-                list[i] = g_strchomp(list[i]);
-                if (g_str_equal(list[i], "")) {
+                autofree(gchar) *comp = g_strchomp(g_ascii_strdown((gchar*)list[i], -1));
+                if (g_str_equal(comp, "")) {
                         continue;
                 }
-                if (g_str_equal(pname, list[i])) {
+                if (g_str_equal(pname, comp)) {
                         return true;
                 }
         }
@@ -280,14 +280,15 @@ bool rpm_is_patched(struct source_package_t *pkg, char *id)
 
 bool rpm_is_ignored(struct source_package_t *pkg, char *id)
 {
-        bool ret = false;
         /* Determine if its ignored. */
         autofree(gchar) *pnamet = g_ascii_strdown((gchar*)id, -1);
-        autofree(gchar) *pname = g_strdup_printf("%s.nopatch", pnamet);
-        autofree(gchar) *tpath = g_build_filename(G_DIR_SEPARATOR_S, pkg->path, pname, NULL);
+        autofree(gchar) *tpath = g_strdup_printf("%s/%s.nopatch", pkg->path, id);
+        autofree(gchar) *tpathl = g_strdup_printf("%s/%s.nopatch", pkg->path, pnamet);
 
-        ret = g_file_test(tpath, G_FILE_TEST_EXISTS);
-        return ret;
+        if (g_file_test(tpath, G_FILE_TEST_EXISTS) || g_file_test(tpathl, G_FILE_TEST_EXISTS)) {
+                return true;
+        }
+        return false;
 }
 
 bool rpm_is_package(const char *filename)
diff --git a/tests/dummy_data/rpm/CVE-2014-5461.patch b/tests/dummy_data/rpm/CVE-2014-5461.patch
new file mode 100644
index 0000000..c99b830
--- /dev/null
+++ b/tests/dummy_data/rpm/CVE-2014-5461.patch
@@ -0,0 +1,13 @@
+diff --git a/src/ldo.c b/src/ldo.c
+index d1bf786..d43f611 100644
+--- a/src/ldo.c
++++ b/src/ldo.c
+@@ -217,7 +217,7 @@ static StkId adjust_varargs (lua_State *L, Proto *p, int actual) {
+     int nvar = actual - nfixargs;  /* number of extra arguments */
+     lua_assert(p->is_vararg & VARARG_HASARG);
+     luaC_checkGC(L);
+-    luaD_checkstack(L, p->maxstacksize);
++    luaD_checkstack(L, p->maxstacksize + p->numparams);
+     htab = luaH_new(L, nvar, 1);  /* create `arg' table */
+     for (i=0; i<nvar; i++)  /* put extra arguments into `arg' table */
+       setobj2n(L, luaH_setnum(L, htab, i+1), L->top - nvar + i);
diff --git a/tests/dummy_data/rpm/cve-2014-5461.patch b/tests/dummy_data/rpm/cve-2014-5461.patch
deleted file mode 100644
index c99b830..0000000
--- a/tests/dummy_data/rpm/cve-2014-5461.patch
+++ /dev/null
@@ -1,13 +0,0 @@
-diff --git a/src/ldo.c b/src/ldo.c
-index d1bf786..d43f611 100644
---- a/src/ldo.c
-+++ b/src/ldo.c
-@@ -217,7 +217,7 @@ static StkId adjust_varargs (lua_State *L, Proto *p, int actual) {
-     int nvar = actual - nfixargs;  /* number of extra arguments */
-     lua_assert(p->is_vararg & VARARG_HASARG);
-     luaC_checkGC(L);
--    luaD_checkstack(L, p->maxstacksize);
-+    luaD_checkstack(L, p->maxstacksize + p->numparams);
-     htab = luaH_new(L, nvar, 1);  /* create `arg' table */
-     for (i=0; i<nvar; i++)  /* put extra arguments into `arg' table */
-       setobj2n(L, luaH_setnum(L, htab, i+1), L->top - nvar + i);
-- 
2.4.6

