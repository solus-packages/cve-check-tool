From 2092c77c5585a02e316d3c2f0a2900b5233e7f25 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <michael.i.doherty@intel.com>
Date: Fri, 10 Jul 2015 15:10:50 +0100
Subject: [PATCH 6/9] Enable running from git tree

Signed-off-by: Ikey Doherty <michael.i.doherty@intel.com>
---
 common.mk        | 14 +++++++++++---
 configure.ac     |  6 ++++++
 docs/Makefile.am |  2 +-
 3 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/common.mk b/common.mk
index 8e5ef6f..6546f30 100644
--- a/common.mk
+++ b/common.mk
@@ -10,9 +10,17 @@ AM_CPPFLAGS = \
 	-I $(top_srcdir)/src/packaging \
 	-I $(top_srcdir)/src/library \
 	-I $(top_srcdir)/src/output \
-	-DDATA_DIRECTORY=\"$(datadir)/cve-check-tool\" \
 	-DSITE_PATH=\"$(sysconfdir)\" \
-	-DTOP_DIR=\"$(abs_top_srcdir)\" \
-	-DMODULE_DIR=\"$(pkglibdir)\"
+	-DTOP_DIR=\"$(abs_top_srcdir)\"
+
+if INTREE
+AM_CPPFLAGS += \
+	-DMODULE_DIR=\"$(abs_top_srcdir)/src/.libs\" \
+	-DDATA_DIRECTORY=\"$(abs_top_srcdir)/data\"
+else
+AM_CPPFLAGS += \
+	-DMODULE_DIR=\"$(pkglibdir)\" \
+	-DDATA_DIRECTORY=\"$(datadir)/cve-check-tool\"
+endif
 
 AUTOMAKE_OPTIONS = color-tests parallel-tests
diff --git a/configure.ac b/configure.ac
index c192c61..6608f28 100644
--- a/configure.ac
+++ b/configure.ac
@@ -46,6 +46,11 @@ if test "x$enable_coverage" = "xyes" ; then
 fi
 AM_CONDITIONAL([COVERAGE], [test "$have_coverage" = "yes"])
 
+AC_ARG_ENABLE(run_in_tree, AS_HELP_STRING([--enable-run-in-tree], [enable running from git tree]))
+if test "x$enable_run_in_tree" = "xyes" ; then
+	AC_DEFINE([INTREE], [1], [In-tree usage enabled])
+fi
+AM_CONDITIONAL([INTREE], [test "$enable_run_in_tree" = "yes"])
 
 AC_CONFIG_FILES([Makefile
                  data/Makefile
@@ -66,6 +71,7 @@ AC_MSG_RESULT([
         datarootdir:            ${datarootdir}
 
         coverage:               ${have_coverage}
+        run-in-tree:            ${enable_run_in_tree}
 
         compiler:               ${CC}
         cflags:                 ${CFLAGS}
diff --git a/docs/Makefile.am b/docs/Makefile.am
index 43256de..5ff869c 100644
--- a/docs/Makefile.am
+++ b/docs/Makefile.am
@@ -1,4 +1,4 @@
--include $(top_srcdir)/common.mk
+include $(top_srcdir)/common.mk
 
 
 dist_man_MANS = \
-- 
2.4.6

