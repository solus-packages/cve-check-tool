From b8ae72f4ff4f4dab33a331374aa3c02e38beea9c Mon Sep 17 00:00:00 2001
From: Ikey Doherty <michael.i.doherty@intel.com>
Date: Mon, 29 Jun 2015 10:23:12 +0100
Subject: [PATCH 02/13] Make CVE patch filenames case insensitive.

Signed-off-by: Ikey Doherty <michael.i.doherty@intel.com>
---
 src/packaging/eopkg.c    | 26 +++++++++++++++-----------
 src/packaging/pkgbuild.c | 12 +++++++-----
 src/packaging/rpm.c      |  2 +-
 3 files changed, 23 insertions(+), 17 deletions(-)

diff --git a/src/packaging/eopkg.c b/src/packaging/eopkg.c
index fd93ca9..a8a9a36 100644
--- a/src/packaging/eopkg.c
+++ b/src/packaging/eopkg.c
@@ -125,26 +125,30 @@ clean:
 
 bool eopkg_is_patched(struct source_package_t *pkg, char *id)
 {
-        bool ret = false;
         /* Determine if its patched. */
         autofree(gchar) *pnamet = g_ascii_strdown((gchar*)id, -1);
-        autofree(gchar) *pname = g_strdup_printf("%s.patch", pnamet);
-        autofree(gchar) *tpath = g_build_filename(G_DIR_SEPARATOR_S, pkg->path, PATCH_PREFIX, pname, NULL);
+        autofree(gchar) *pnamel = g_strdup_printf("%s/%s/%s.patch", pkg->path, PATCH_PREFIX, pnamet);
+        autofree(gchar) *pname = g_strdup_printf("%s/%s/%s.patch", pkg->path, PATCH_PREFIX, id);
 
-        ret = g_file_test(tpath, G_FILE_TEST_EXISTS);
-        return ret;
+        if (g_file_test(pname, G_FILE_TEST_EXISTS) || g_file_test(pnamel, G_FILE_TEST_EXISTS)) {
+                return true;
+        }
+
+        return false;
 }
 
 bool eopkg_is_ignored(struct source_package_t *pkg, char *id)
 {
-        bool ret = false;
-        /* Determine if its ignored. */
+        /* Determine if its patched. */
         autofree(gchar) *pnamet = g_ascii_strdown((gchar*)id, -1);
-        autofree(gchar) *pname = g_strdup_printf("%s.nopatch", pnamet);
-        autofree(gchar) *tpath = g_build_filename(G_DIR_SEPARATOR_S, pkg->path, PATCH_PREFIX, pname, NULL);
+        autofree(gchar) *pnamel = g_strdup_printf("%s/%s/%s.nopatch", pkg->path, PATCH_PREFIX, pnamet);
+        autofree(gchar) *pname = g_strdup_printf("%s/%s/%s.nopatch", pkg->path, PATCH_PREFIX, id);
+
+        if (g_file_test(pname, G_FILE_TEST_EXISTS) || g_file_test(pnamel, G_FILE_TEST_EXISTS)) {
+                return true;
+        }
 
-        ret = g_file_test(tpath, G_FILE_TEST_EXISTS);
-        return ret;
+        return false;
 }
 
 bool eopkg_is_package(const char *filename)
diff --git a/src/packaging/pkgbuild.c b/src/packaging/pkgbuild.c
index 0a3c797..692c538 100644
--- a/src/packaging/pkgbuild.c
+++ b/src/packaging/pkgbuild.c
@@ -94,14 +94,16 @@ clean:
 
 bool pkgbuild_is_patched(struct source_package_t *pkg, char *id)
 {
-        bool ret = false;
         /* Determine if its patched. */
         autofree(gchar) *pnamet = g_ascii_strdown((gchar*)id, -1);
-        autofree(gchar) *pname = g_strdup_printf("%s.patch", pnamet);
-        autofree(gchar) *tpath = g_build_filename(G_DIR_SEPARATOR_S, pkg->path, pname, NULL);
+        autofree(gchar) *pnamel = g_strdup_printf("%s/%s.nopatch", pkg->path, pnamet);
+        autofree(gchar) *pname = g_strdup_printf("%s/%s.nopatch", pkg->path, id);
 
-        ret = g_file_test(tpath, G_FILE_TEST_EXISTS);
-        return ret;
+        if (g_file_test(pname, G_FILE_TEST_EXISTS) || g_file_test(pnamel, G_FILE_TEST_EXISTS)) {
+                return true;
+        }
+
+        return false;
 }
 
 bool pkgbuild_is_package(const char *filename)
diff --git a/src/packaging/rpm.c b/src/packaging/rpm.c
index 65fb18f..bb052e5 100644
--- a/src/packaging/rpm.c
+++ b/src/packaging/rpm.c
@@ -191,7 +191,7 @@ struct source_package_t *rpm_inspect_spec(const char *filename)
                                 fprintf(stderr, "%s is broken - applying \"patch%s\" which isn't declared\n", filename, key);
                                 continue;
                         }
-                        lpatches = g_list_append(lpatches, g_strdup(val));
+                        lpatches = g_list_append(lpatches, g_ascii_strdown(val, -1));
                         goto clean;
                 }
                 if (!strchr(read, ':')) {
-- 
2.4.6

